---
title: "An Overview of Oregon's State Funding Allocation"
subtitle: "Subtitle"
editor: visual
author: "Havisha Khurana"
date: "today"
date-format: "full"
format: 
    html:
        embed-resources: true
        code-fold: true
        code-link: true
        theme: journal
        highlight: tango
        df-print: paged
        self-contained-math: true
        abstract: You can add an abstract here
        abstract-title: Abstract Title
        toc: true
        toc_float: true
        toc_location: "left"
        toc_expand: true
        code-overflow: wrap
        code-line-numbers: true
        code-copy: true
        footnotes-hover: true
        highlight-style: pygments
execute:
   warning: false
   error: false
   message: false
---

The state of Oregon uses a student-based funding model to allocate revenues to its 197 school districts. In this analysis, I will describe descriptive trends in district enrollment, districts' state-funding allocation, district revenue, and district expenditure related to students with disabilities whose services cost more than a given threshold and are paid by the grant called *High-Cost Disability Grant*.

```{r}
# load libraries
library(tidyverse)
library(gghighlight)
#library(geomtextpath)
library(patchwork)
```

```{r}
# load r with plots code
source("code/writeup_plots.R")
```

## District ADM Data

```{r}
# data prep
district_year_adm <- readr::read_csv(here::here("data_clean/district_year_admw.csv")) %>%
  select(-1) %>%
  # make columns for iep related information
  #group_by(school_year, entry_name, district_name) 
  rowwise() %>%
  mutate(district_iep_students = 
           ifelse(grepl("IEP Students", category), parse_number(category),NA)) %>%
  ungroup() %>%
  group_by(district_id, school_year) %>%
  mutate(district_iep_students = sum(district_iep_students, na.rm = T),
         district_iep_percent = district_iep_students/current_year_adm_district, 
         district_iep_11 = sum(current_year_adm[grepl("IEP Students", category)]),
         district_iep_above_11 = sum(current_year_adm[grepl("IEP Above", category)]),
         district_iep_no_extra = district_iep_students - district_iep_11 - district_iep_above_11,
         district_iep_eff_weight = (district_iep_11 + district_iep_above_11)/district_iep_students
         )

district_details <- district_year_adm %>%
  distinct(school_year, district_id, district_name, current_year_adm_district)


hcd_year <-  readr::read_csv(here::here("data_clean/hcd_year_good.csv")) %>%
  select(-1) %>%
  rename("district_id" = "dist_id") %>%
  left_join(district_details)

hcd_all_year <- readr::read_csv("data_clean/hcd_state_2003_2022.csv") %>%
  select(-1) 
```

### Trends in Enrollment Across Years with the Average Highlighted

```{r}
cont_across_years_w_mean(district_year_adm,
             var_x = school_year,
             var_y = current_year_adm_district,
             mean_type = 2,
             mean_numerator = "",
             mean_denominator = "",
             log_on = T,
             round_pos = 0,
             lab_y = "Log of Student Membership")
```

### Trends in Enrollment Across Years with Districts > 30k enrollment Highlighted

```{r}
cont_across_years(district_year_adm,
             var_x = school_year,
             var_y = current_year_adm_district,
             log_on = F,
             lab_y = "Student Membership")+
  gghighlight(max(current_year_adm_district) > 30000,
              label_key = district_name,
              unhighlighted_params = list(alpha = 0.5)) +
  scale_color_brewer(palette = "Dark2") 
```

### Trends in Enrollment Across Years with Districta 13-20k enrollment Highlighted

```{r}
cont_across_years(district_year_adm,
             var_x = school_year,
             var_y = current_year_adm_district,
             log_on = F,
             lab_y = "Student Membership")+
  gghighlight(max(current_year_adm_district) > 13000 & max(current_year_adm_district) < 30000,
              label_key = district_name,
              unhighlighted_params = list(alpha = 0.5)) +
  scale_color_brewer(palette = "Dark2")
```

### Trends in Enrollment Across Years with Districts <10 students Highlighted

```{r}
cont_across_years(district_year_adm,
             var_x = school_year,
             var_y = current_year_adm_district,
             log_on = T,
             lab_y = "Log of Student Membership")+
  gghighlight(max(current_year_adm_district) < 10,
              label_key = district_name,
              unhighlighted_params = list(alpha = 0.5)) +
  scale_color_brewer(palette = "Dark2")
```

### Trends in State - Subgroup Enrollment 

```{r}
district_year_subgroup_enrollment <- district_year_adm %>%
  distinct(school_year, district_id, district_name, district_iep_students) %>%
  mutate(category = "IEP") %>%
  rename("current_year_adm" = "district_iep_students") %>%
  rbind(
  district_year_adm %>%
  filter(!grepl("IEP|School|Scholars", category)) %>%
  group_by(school_year, category, district_id, district_name) %>%
  summarize(current_year_adm = sum(current_year_adm))) %>%
  rbind(hcd_year %>%
          select(school_year, actual_hcd_count, district_id, district_name) %>%
          rename("current_year_adm" = "actual_hcd_count") %>%
          mutate(category = "HCD")) %>%
  mutate(category = gsub("Students in ", "", category)) %>%
  group_by(school_year, district_id) %>%
  mutate(
    prop_current_year_adm = current_year_adm/current_year_adm[category == "ADMr"],
    total = current_year_adm[category == "ADMr"]
  )
```

```{r}
state_year_subgroup_enrollment <- district_year_subgroup_enrollment %>%
  ungroup() %>%
  group_by(school_year, category) %>%
  summarize(total = sum(current_year_adm)) %>%
  rbind(hcd_all_year %>%
          filter(school_year >= 2011, school_year < 2018) %>%
          select(school_year, eligible_students) %>%
          rename("total" = "eligible_students") %>%
          mutate(category = "HCD")) %>%
  group_by(school_year) %>%
  mutate(
    percentage = round(total*100/total[category == "ADMr"],3)
  ) %>%
  filter(category != "ADMr", !is.na(percentage))
```

```{r}
ggplot(filter(state_year_subgroup_enrollment, school_year < 2023),
       aes(x = school_year,
               node = category,
               fill = category,
               value = percentage)) +
  geom_sankey_bump(space = 0, type = "alluvial", color = "transparent", smooth = 6,
                   alpha = 0.6) +
  scale_fill_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = 2011:2022) +
  theme_sankey_bump() +
  annotate("label",
           x = 2012,
           label = "Poverty",
           y = 35)+
    annotate("label",
           x = 2012,
           label = "IEP",
           y = 19)+
    annotate("label",
           x = 2012,
           label = "EL",
           y = 8)+
  labs(x = NULL,
       y = "Percentage",
       fill = NULL,
       color = NULL) +
  theme(legend.position = "bottom") +
  guides(color = "none",
         fill = "none")+
  labs(title = "State-level subgroup representation")
```

### Trends in District - Subgroup Enrollment Across Years

```{r}
categories <- unique(district_year_subgroup_enrollment$category)[c(1,3:7)]

# HCD plot weird
map(categories, ~cont_across_years_w_mean(df = filter(district_year_subgroup_enrollment, category == .x), var_x = school_year, var_y = prop_current_year_adm, log_on = F,
                                          mean_numerator = current_year_adm,
                                          mean_denominator = total,
             lab_y = "Proportion of District Membeship") +
      labs(title = .x))
```


### Trends in District - Subgroup Enrollment by Total Enrollment For One-Year

```{r}

map(categories, ~one_year_scatterplot_w_bars(df = filter(district_year_subgroup_enrollment, category == .x), var_x = total, var_y = prop_current_year_adm, log_x_on = T, 
                                          log_y_on = F,
                                          var_x_name = "District Membership", 
                                          var_y_name = .x,
                                  add_bars = T))



```

## District Funds Allocation Data

```{r}
district_year_adm_summary <- district_year_adm %>%
  distinct(school_year, district_id, current_year_adm_district, current_year_admw_district, current_year_eff_admw_district) %>%
  mutate(
    adm_admw_ratio = current_year_admw_district/current_year_adm_district,
    eff_adm_admw_ratio = current_year_eff_admw_district/current_year_adm_district,
    difference_ratio = eff_adm_admw_ratio - adm_admw_ratio
  ) 

one_year_scatterplot_w_bars(df = district_year_adm_summary, 
                            var_x = current_year_adm_district, 
                            var_y = adm_admw_ratio, 
                            log_x_on = T, 
                            log_y_on = F,
                            var_x_name = "Current Year District Membership", 
                            var_y_name = "Allocation Ratio",
                                  add_bars = T)


one_year_scatterplot_w_bars(df = district_year_adm_summary, 
                            var_x = current_year_adm_district, 
                            var_y = eff_adm_admw_ratio, 
                            log_x_on = T, 
                            log_y_on = F,
                            var_x_name = "Current Year District Membership", 
                            var_y_name = "Effective Allocation Ratio",
                                  add_bars = T)

one_year_scatterplot_w_bars(df = district_year_adm_summary, 
                                        
                            var_x =current_year_adm_district, 
                            var_y =  difference_ratio, 
                            log_x_on = T, 
                            log_y_on = F,
                            var_x_name = "Current Year Enrollment", 
                            var_y_name = "Difference: Effective and Calculated Allocation Ratio",
                                  add_bars = T)

# library(lme4)
# 
# lmer(current_year_adm_district ~ 1 | district_id,
#      data = district_year_adm_summary)
#99.7% variance in the ADM is explained by the between-districts difference.
# The enrollment remains pretty stable between districts across time.
```

```{r}
#| eval: false
# **What proportion of District-ADM do districts get?** The allocation rate (ADM-Weighted/ADM) per student has an exponential decay shape: Small districts (with less than 100 students) get between 2 to 9 times the allocation per student. Districts between 100 to 1000 students get between 1 to 2 times the allocation per student. The relationship is close to the 1 line for schools with higher than 1000 students. The median allocation ratio is `r median(district_year_adm_ratio$adm_admw_ratio)`. About 20% of the variation in the allocation ratio is explained at the between-district levels.
# 
# **How much do schools really get?** Since Oregon has a safeguard rule where the districts get max of their previous or current year weighted ADM, most school districts get funds allocated more than their resident schools in a given year. In the whole sample, only proportion of the times did districts get funds based on their current year ADM.
# 
# **What proportion of district ADM are categories that get exclusive funding?** **And variation that is explained by between district factors?**

```

## Revenue Data


```{r}
revenue <- readr::read_csv("data_clean/district_revenue_sources_2019_2022.csv") %>%
  select(-1) %>%
  left_join(district_details)
```

### State Trends in Per-pupil revenue based on sources

```{r}
#how much money?
revenue %>%
  group_by(school_year) %>%
  summarize(total_year = sum(revenue_dollar, na.rm = T)) %>%
  ggplot(., aes(x = school_year, y = total_year)) +
  geom_col(alpha = 0.7, fill = "#A6761D") +
  scale_y_continuous(
    breaks = c(0,5,10,15,20)*1000000000,
    labels = c("0", "5B", "10B", "15B", "20B")
    ) +
  labs(x = NULL,
       y = "Total Revenue") +
  theme_minimal()
```


```{r}
# state-revenue trends
revenue %>%
  group_by(school_year, source) %>%
  summarize(
    total_source = sum(revenue_dollar, na.rm = T)
  ) %>%
  group_by(school_year) %>%
  mutate(total_year = sum(total_source),
         per_category = total_source/total_year) %>%
  ggplot(., aes(x = school_year, y = per_category, fill = str_to_title(source))) +
  geom_col(alpha = 0.7) +
  geom_text(aes(label = round(per_category, 2),
                color = per_category > 0.1),
            position = position_fill()) +
  scale_fill_brewer(palette = "Dark2") +
  scale_color_manual(values = c("transparent","gray10")) +
  guides(
    color = "none"
  ) +
  labs(
    x = "",
    y = "Proportion of Revenue",
    fill = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    legend.position = "top"
  )
```


```{r}
# without other
revenue %>%
  filter(source != "other") %>%
  group_by(school_year, source) %>%
  summarize(
    total_source = sum(revenue_dollar, na.rm = T)
  ) %>%
  group_by(school_year) %>%
  mutate(total_year = sum(total_source),
         per_category = total_source/total_year) %>%
  ggplot(., aes(x = school_year, y = per_category, fill = source)) +
  geom_col(alpha = 0.7) +
  geom_text(aes(label = round(per_category, 2),
                color = per_category > 0.05),
            position = position_fill()) +
  scale_fill_brewer(palette = "Dark2") +
  scale_color_manual(values = c("transparent","gray10")) +
  guides(
    color = "none"
  ) +
  labs(
    x = "",
    y = "Proportion of Revenue",
  fill = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    legend.position = "top"
  )
```
### Trends in Per-pupil revenue by Districts based on sources

```{r}
revenue_sources <- unique(revenue$source)

map(revenue_sources, ~cont_across_years_w_mean(df = filter(revenue, source == .x) %>%
                                                 mutate(ppe = revenue_dollar/current_year_adm_district), 
                                               var_x = school_year, 
                                               var_y = ppe, log_on = T,
                                               mean_type = 2,
                                          mean_numerator = "",
                                          mean_denominator = "",
                                          add_dollar = T,
                                          lab_y = "Per-pupil revenue") +
      labs(title = paste0("From ", str_to_title(.x)," sources")))
```

Describe: Other includes balance in the state account.

### Trends in Revenue by District Enrollment


```{r}
map(revenue_sources, ~one_year_scatterplot_w_bars(df = filter(revenue, source == .x) %>%
                                                 mutate(ppe = revenue_dollar/current_year_adm_district), 
                                               var_x = current_year_adm_district, 
                                               var_y = ppe, 
                                               log_x_on = T,
                                               log_y_on = F,
                                              var_x_name = "Current Year Enrollment", 
                            var_y_name = paste0("Per-pupil Revenue: ",str_to_title(.x)),
                                  add_bars = T))
```


## HCD Population


### Students eligible for HCD and Grant Amount

```{r}
hcd_eligible <- hcd_bar_plot(df = hcd_all_year,
             var_x = eligible_students,
             var_label = eligible_students,
             title = "Eligible Students",
             nudge = -300, seed = 2)

hcd_grant <- hcd_bar_plot(df = mutate(hcd_all_year, grant_amount_text = gsub("0{1,}","M", grant_amount)),
             var_x = grant_amount,
             var_label = grant_amount_text,
             title = "Grant Amount", seed = 2,
             position = "right")


hcd_eligible + hcd_grant
```
### Students eligible for HCD and Per-pupil expenditure above threshold

```{r}
expense_per_student <- hcd_bar_plot(df = mutate(hcd_all_year, ppe = expenditure_above_threshold/eligible_students),
             var_x = ppe,
             var_label = scales::dollar(round(ppe, -2)),
             title = "Average Expense per student", seed = 2,
             position = "right")

hcd_eligible + expense_per_student
```

### Per-pupil reimbursment and Per-pupil expenditure above threshold


```{r}
reimbusement_per_student <- hcd_bar_plot(df = mutate(hcd_all_year, ppe = expenditure_above_threshold*calculated_rate/eligible_students),
             var_x = ppe,
             var_label = scales::dollar(round(ppe, -2)),
             title = "Average Reimbursement per student", seed = 2,
             position = "left")

reimbusement_per_student + expense_per_student
```


```{r}
#| eval: false

# -   Trends in aggregated expenditure by categories defined in the dataset - and variation
# 
# Main interest: funding for and expenditure on two groups: SpEd and EL
# 
# 
# <Is the 11% clean variation, or 2 year max a clean variation? If they are gaming one, are they gaming the other?>
# The district level optimization around the rules.
# 
# -   prop of iep adm that's from 11% and that's on top
# 
# -   what proportion of oregon students get funding through the double funding route?
# 
# -   Expenditure: Use same criteria to make the aggregated categories but separate for flagged and not, and
# 
# -   Evaluate discontinuity
```


